<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Ladd casa del terror</title>

<!-- Favicons -->
<link rel="icon" href="favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="manifest" href="site.webmanifest">

<style>
  :root{
    --neon:#00ff00;
    --ink:#eaeaea;
    --muted:#cfcfcf;
    --blood:#ff2b2b;

    /* ‚úÖ Glitch del TEXTO (0..1) ‚Äî S√ç ligado al volumen */
    --g: .55;
    --gpx: 10px;

    /* ‚úÖ VHS glitch ‚Äî NO ligado al volumen */
    --gvhs: .78;

    /* ‚úÖ Frame congelado en PAUSE (lo setea JS al pausar) */
    --hx: 0px;
    --hy: 0px;
    --hblur: 0.2px;
    --hr: -2.4px;
    --hb:  2.8px;
    --t1: 18%;
    --t2: 50%;
    --t3: 76%;

    /* ‚úÖ Bot√≥n psicod√©lico (ajuste fino y robusto multi-dispositivo) */
    /* Lo muevo: m√°s a la derecha y un poco m√°s arriba */
    --psy-x: 78.2%;
    --psy-y: 72.8%;
    --psy-s: 11.2%;
  }

  *{ box-sizing:border-box; }
  html, body{ -webkit-tap-highlight-color: transparent; }

  button, a, .crt{
    -webkit-tap-highlight-color: transparent;
    -webkit-appearance: none;
    appearance: none;
    outline: none;
    touch-action: manipulation;
  }

  :focus{ outline:none; }
  button:focus-visible, a:focus-visible, .crt:focus-visible{
    outline: 2px solid rgba(0,255,0,.75);
    outline-offset: 3px;
  }

  body{
    margin:0;
    font-family: Arial, sans-serif;
    color:var(--ink);
    min-height:100vh;
    display:flex;
    justify-content:center;

    padding:
      calc(32px + env(safe-area-inset-top))
      calc(14px + env(safe-area-inset-right))
      calc(32px + env(safe-area-inset-bottom))
      calc(14px + env(safe-area-inset-left));

    overflow-x:hidden;

    background:
      repeating-radial-gradient(
        circle at 30% 40%,
        rgba(255,255,255,.04) 0,
        rgba(255,255,255,.04) 1px,
        transparent 2px,
        transparent 7px
      ),
      repeating-radial-gradient(
        circle at 70% 60%,
        rgba(255,255,255,.025) 0,
        rgba(255,255,255,.025) 1px,
        transparent 1px,
        transparent 4px
      ),
      linear-gradient(
        180deg,
        rgba(255,255,255,.06),
        rgba(0,0,0,.08)
      ),
      linear-gradient(
        180deg,
        #1a1412,
        #0e0a09 50%,
        #050303
      );
  }

  body.psy-open{
    overflow:hidden;
    height:100vh;
    touch-action:none;
  }

  .wrap{
    width:100%;
    max-width:820px;
    text-align:center;
  }

  .back{
    display:inline-block;
    color:var(--ink);
    text-decoration:none;
    opacity:.75;
    margin-bottom:14px;
    border-bottom:1px dotted rgba(255,255,255,.35);
    padding-bottom:2px;
  }
  .back:hover{ opacity:1; color:var(--neon); border-bottom-color:rgba(0,255,0,.65); }

  h1{
    margin: 0 0 6px 0;
    font-size: 22px;
    letter-spacing: .22em;
    font-weight: 800;
    text-transform: uppercase;
    color: var(--ink);
    opacity: .95;
  }

  /* ===== Subt√≠tulo rojo con glitch ===== */
  .subtitle-wrap{ width: 100%; display:block; margin: 0 0 6px 0; }

  .subtitle{
    position:relative;
    display:block;
    width: 100%;
    margin: 0;
    padding: 0;
    font: inherit;
    font-size: 18px;
    letter-spacing: .22em;
    font-weight: 800;
    text-transform: uppercase;
    color: var(--blood);
    opacity: .95;
    line-height: 1.05;
    transform: translateZ(0);
    text-shadow:
      0 0 14px rgba(255,43,43,.15),
      0 0 2px rgba(255,43,43,.25);
    user-select:none;
    animation: red-flicker 5.4s infinite;
  }

  .subtitle::before,
  .subtitle::after{
    content: attr(data-text);
    position:absolute;
    inset:0;
    pointer-events:none;
    opacity:.70;
    mix-blend-mode: screen;
  }

  .subtitle::before{
    color: rgba(255, 60, 60, .95);
    transform: translate(-1px, 0);
    clip-path: inset(0 0 60% 0);
    animation: red-glitch-a 3.6s infinite;
  }

  .subtitle::after{
    color: rgba(255, 0, 0, .95);
    transform: translate(1px, 0);
    clip-path: inset(55% 0 0 0);
    animation: red-glitch-b 4.4s infinite;
  }

  /* ===== PLAYING: glitch del texto ligado a --g (volumen) ===== */
  body.playing .subtitle{
    transform: translateZ(0);
    text-shadow:
      0 0 calc(10px + (22px * var(--g))) rgba(255,43,43,.28),
      0 0 calc(1px + (4px * var(--g))) rgba(255,43,43,.45);
    filter:
      contrast(calc(1 + (0.25 * var(--g))))
      saturate(calc(1 + (0.18 * var(--g))))
      hue-rotate(calc(-2deg + (4deg * var(--g))));
    animation:
      red-flicker-playing calc(1.9s - (0.9s * var(--g))) infinite steps(2,end),
      title-glitch-jitter calc(0.45s - (0.30s * var(--g))) infinite steps(2,end),
      signal-tear calc(1.6s - (1.0s * var(--g))) infinite steps(2,end);
  }

  body.playing .subtitle::before{
    opacity: calc(0.12 + (0.83 * var(--g)));
    transform: translate(calc(-1px - (var(--gpx) * var(--g))), calc(-0.5px - (2px * var(--g))));
    animation: red-glitch-a-play calc(0.70s - (0.45s * var(--g))) infinite steps(2,end);
    filter: brightness(1.05);
  }

  body.playing .subtitle::after{
    opacity: calc(0.12 + (0.83 * var(--g)));
    transform: translate(calc(1px + (var(--gpx) * var(--g))), calc(0.5px + (2px * var(--g))));
    animation: red-glitch-b-play calc(0.62s - (0.45s * var(--g))) infinite steps(2,end);
    filter: brightness(1.05);
  }

  /* --- anims base --- */
  @keyframes red-flicker{
    0%, 55%, 100% { filter: none; transform: translateZ(0); }
    60% { filter: contrast(1.05); }
    63% { filter: contrast(1.10) saturate(1.05); transform: translateY(-.2px); }
    66% { filter: none; transform: translateY(0); }
  }
  @keyframes red-flicker-playing{
    0%, 100% { filter: none; }
    15% { filter: contrast(1.12) saturate(1.10); }
    30% { filter: contrast(1.20) saturate(1.12); }
    45% { filter: contrast(1.15); }
    70% { filter: none; }
    85% { filter: contrast(1.10); }
  }
  @keyframes title-glitch-jitter{
    0%{ transform: translate(0,0) skewX(0deg); }
    20%{ transform: translate(-1px,0) skewX(-6deg); }
    40%{ transform: translate(2px,-1px) skewX(7deg); }
    60%{ transform: translate(-2px,1px) skewX(-10deg); }
    80%{ transform: translate(1px,0) skewX(5deg); }
    100%{ transform: translate(0,0) skewX(0deg); }
  }
  @keyframes signal-tear{
    0%, 100% { filter: none; }
    18% { filter: contrast(1.1) saturate(1.05); }
    19% { filter: contrast(1.25) saturate(1.2); }
    20% { filter: none; }
    58% { filter: contrast(1.12); }
    59% { filter: contrast(1.28) saturate(1.15); }
    60% { filter: none; }
  }
  @keyframes red-glitch-a{
    0%, 92%, 100% { transform: translate(-1px, 0); clip-path: inset(0 0 60% 0); }
    93% { transform: translate(-2px, -1px); clip-path: inset(0 0 35% 0); }
    94% { transform: translate(-1px, 1px); clip-path: inset(10% 0 45% 0); }
    95% { transform: translate(-3px, 0); clip-path: inset(0 0 70% 0); }
    96% { transform: translate(-1px, 0); clip-path: inset(0 0 60% 0); }
  }
  @keyframes red-glitch-b{
    0%, 90%, 100% { transform: translate(1px, 0); clip-path: inset(55% 0 0 0); }
    91% { transform: translate(2px, 1px); clip-path: inset(60% 0 0 0); }
    92% { transform: translate(3px, -1px); clip-path: inset(48% 0 8% 0); }
    93% { transform: translate(2px, 0); clip-path: inset(70% 0 0 0); }
    94% { transform: translate(1px, 0); clip-path: inset(55% 0 0 0); }
  }
  @keyframes red-glitch-a-play{
    0%   { clip-path: inset(10% 0 82% 0); transform: translate(-4px,0); }
    10%  { clip-path: inset(40% 0 30% 0); transform: translate(-2px,-1px); }
    20%  { clip-path: inset(0 0 60% 0);  transform: translate(-6px,1px); }
    30%  { clip-path: inset(70% 0 5% 0); transform: translate(-1px,0); }
    40%  { clip-path: inset(20% 0 55% 0); transform: translate(-5px,-1px); }
    50%  { clip-path: inset(55% 0 20% 0); transform: translate(-2px,1px); }
    60%  { clip-path: inset(5% 0 75% 0); transform: translate(-7px,0); }
    70%  { clip-path: inset(85% 0 0 0); transform: translate(-3px,-1px); }
    80%  { clip-path: inset(35% 0 40% 0); transform: translate(-6px,1px); }
    90%  { clip-path: inset(0 0 88% 0);  transform: translate(-2px,0); }
    100% { clip-path: inset(10% 0 82% 0); transform: translate(-4px,0); }
  }
  @keyframes red-glitch-b-play{
    0%   { clip-path: inset(75% 0 5% 0); transform: translate(5px,0); }
    12%  { clip-path: inset(50% 0 25% 0); transform: translate(2px,1px); }
    24%  { clip-path: inset(10% 0 70% 0); transform: translate(7px,-1px); }
    36%  { clip-path: inset(90% 0 0 0); transform: translate(3px,0); }
    48%  { clip-path: inset(30% 0 45% 0); transform: translate(6px,1px); }
    60%  { clip-path: inset(0 0 92% 0); transform: translate(2px,0); }
    72%  { clip-path: inset(62% 0 18% 0); transform: translate(8px,-1px); }
    84%  { clip-path: inset(15% 0 65% 0); transform: translate(4px,1px); }
    100% { clip-path: inset(75% 0 5% 0); transform: translate(5px,0); }
  }

  /* TV CRT */
  .crt{
    position:relative;
    width:fit-content;
    margin:12px auto 18px;
    isolation:isolate;
    cursor: default;
    border-radius:12px;
  }

  #cover{
    width:100%;
    max-width:420px;
    border-radius:12px;
    display:block;
    filter:drop-shadow(0 0 22px rgba(0,0,0,.85));
    animation: crt-flicker 4.5s infinite;
    transition: transform .2s ease;
    user-select:none;
    -webkit-user-drag:none;
    will-change: transform, filter;
  }

  .crt::before{
    content:"";
    position:absolute;
    inset:0;
    background:
      repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,.025),
        rgba(255,255,255,.025) 1px,
        transparent 1px,
        transparent 3px
      );
    pointer-events:none;
    mix-blend-mode:overlay;
    opacity:.25;
    z-index:2;
    border-radius:12px;
  }

  .crt:active #cover{ transform: translateY(-1px); }
  .crt:hover #cover{ transform: translateY(-2px); animation: crt-glitch .35s steps(2,end); }

  /* ‚úÖ Hotspot (tap-area grande) + bot√≥n visible (m√°s peque√±o) */
  .tv-psy-hotspot{
    position:absolute;
    left: var(--psy-x);
    top:  var(--psy-y);

    /* Tap area */
    width: var(--psy-s);
    min-width: 38px;
    max-width: 66px;
    aspect-ratio: 1 / 1;

    border-radius:999px;
    transform: translate(-50%,-50%);
    z-index: 6;
    cursor:pointer;
    pointer-events:auto;

    /* Tap area casi invisible */
    background: transparent;
    border: 0;
    padding: 0;

    /* Esto evita ‚Äúselecci√≥n‚Äù rara en iOS */
    -webkit-user-select: none;
    user-select: none;
    touch-action: manipulation;
  }

  /* Bot√≥n visible (el ‚Äúpunto‚Äù real) */
  .tv-psy-hotspot::before{
    content:"";
    position:absolute;
    inset: 22%; /* tama√±o del punto dentro del tap-area */
    border-radius:999px;

    background: radial-gradient(circle at 35% 30%,
      rgba(255,255,255,.98) 0%,
      rgba(0,255,0,.98) 28%,
      rgba(0,255,0,.50) 52%,
      rgba(0,0,0,0) 72%
    );

    border: 1px solid rgba(0,255,0,.72);

    box-shadow:
      0 0 10px rgba(0,255,0,.60),
      0 0 28px rgba(0,255,0,.36),
      0 0 74px rgba(0,255,0,.18);

    animation: tv-btn-flicker 1.05s steps(2,end) infinite;
  }

  /* Halo exterior (m√°s evidente, pero fino) */
  .tv-psy-hotspot::after{
    content:"";
    position:absolute;
    inset: 6%;
    border-radius:999px;
    border: 2px dashed rgba(0,255,0,.30);
    opacity:.90;
    filter: blur(.25px);
    animation: tv-btn-halo 2.4s linear infinite;
    pointer-events:none;
  }

  /* En playing, m√°s ‚Äúvivo‚Äù */
  body.playing .tv-psy-hotspot::before{
    animation-duration: .62s;
    box-shadow:
      0 0 14px rgba(0,255,0,.78),
      0 0 40px rgba(0,255,0,.46),
      0 0 96px rgba(0,255,0,.22);
  }
  body.playing .tv-psy-hotspot::after{
    opacity: 1;
    border-color: rgba(0,255,0,.38);
    animation-duration: 1.8s;
  }

  @keyframes tv-btn-flicker{
    0%   { opacity: .55; filter: saturate(1.1) brightness(1.0); transform: scale(1); }
    12%  { opacity: 1;   filter: saturate(1.9) brightness(1.28); transform: scale(1.08); }
    25%  { opacity: .65; filter: saturate(1.2) brightness(1.06); transform: scale(1.02); }
    45%  { opacity: 1;   filter: saturate(2.0) brightness(1.32); transform: scale(1.10); }
    70%  { opacity: .62; filter: saturate(1.2) brightness(1.02); transform: scale(1.00); }
    100% { opacity: .55; filter: saturate(1.1) brightness(1.0); transform: scale(1); }
  }
  @keyframes tv-btn-halo{
    0%{ transform: rotate(0deg); opacity:.45; }
    50%{ opacity:1; }
    100%{ transform: rotate(360deg); opacity:.45; }
  }

  /* Accesibilidad: foco */
  .tv-psy-hotspot:focus-visible{
    outline: 2px solid rgba(0,255,0,.75);
    outline-offset: 4px;
  }

  /* ===========================
     VHS GLITCH SOLO EN LA PANTALLA
     =========================== */
  .tv-screen{
    position:absolute;
    left: 17.63%;
    top: 22.75%;
    width: 62.99%;
    height: 46.83%;
    overflow:hidden;
    pointer-events:none;
    z-index:3;
    border-radius: 10px;
    isolation:isolate;
    transform: translateZ(0);
  }

  .vhs{
    position:absolute;
    inset:-14%;
    opacity:0;
    transform: translateZ(0);
    mix-blend-mode: screen;
    filter: contrast(1.22) saturate(1.26);
    animation-fill-mode: both;
  }

  /* PLAY: animado */
  body.playing .vhs{
    opacity: calc(0.22 + (0.78 * var(--gvhs)));
    animation:
      vhs-global-jitter 0.18s infinite steps(2,end),
      vhs-vertical-float 1.35s infinite ease-in-out;
  }

  /* ‚úÖ PAUSE: visible + ‚Äúcongelado‚Äù + micro vida + ticks VHS */
  body.paused .vhs{
    opacity: calc(0.28 + (0.72 * var(--gvhs)));
    transform: translate3d(var(--hx), var(--hy), 0);
    filter:
      contrast(1.23) saturate(1.26)
      blur(var(--hblur));
    animation:
      vhs-hold-breathe 5.2s infinite steps(2,end),
      vhs-hold-tick 7.8s infinite steps(2,end);
  }

  .vhs::before{
    content:"";
    position:absolute;
    inset:0;
    background:
      repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,0.07) 0px,
        rgba(255,255,255,0.07) 1px,
        rgba(0,0,0,0) 3px
      ),
      repeating-linear-gradient(
        90deg,
        rgba(255,255,255,0.05) 0px,
        rgba(255,255,255,0.05) 1px,
        rgba(0,0,0,0) 6px
      );
    opacity: 0.95;
    animation: vhs-noise 0.12s infinite steps(2,end);
  }

  .vhs::after{
    content:"";
    position:absolute;
    left:-6%;
    right:-6%;
    top:-30%;
    height: 18%;
    background: linear-gradient(to bottom,
      rgba(255,255,255,0) 0%,
      rgba(160,255,160,0.22) 35%,
      rgba(255,255,255,0.36) 50%,
      rgba(160,255,160,0.22) 65%,
      rgba(255,255,255,0) 100%
    );
    filter: blur(2.3px);
    opacity: 1;
    animation: vhs-track 1.05s infinite linear;
  }

  /* PAUSE: el ruido NO se apaga, se ‚Äúralentiza‚Äù */
  body.paused .vhs::before{
    animation: vhs-noise-hold 1.25s infinite steps(2,end);
    opacity: 0.92;
  }

  /* PAUSE: tracking casi parado */
  body.paused .vhs::after{
    animation: vhs-track-hold 8.2s infinite steps(2,end);
    opacity: 0.95;
  }

  .vhs .chroma{
    position:absolute;
    inset:0;
    opacity:0;
    pointer-events:none;
    mix-blend-mode: screen;
  }
  body.playing .vhs .chroma{ opacity: 0.22; }
  body.paused  .vhs .chroma{ opacity: 0.26; }

  .vhs .chroma.r{
    background:
      repeating-linear-gradient(to bottom, rgba(255,0,0,0.11), rgba(255,0,0,0.11) 1px, transparent 3px);
    transform: translateX(-3.4px);
    animation: chroma-r 0.28s infinite steps(2,end);
  }
  .vhs .chroma.b{
    background:
      repeating-linear-gradient(to bottom, rgba(0,120,255,0.11), rgba(0,120,255,0.11) 1px, transparent 3px);
    transform: translateX(3.8px);
    animation: chroma-b 0.26s infinite steps(2,end);
  }

  /* PAUSE: cromas ‚Äúcongelados‚Äù */
  body.paused .vhs .chroma.r{ transform: translateX(var(--hr)); animation: chroma-hold-r 6.8s infinite steps(2,end); }
  body.paused .vhs .chroma.b{ transform: translateX(var(--hb)); animation: chroma-hold-b 7.6s infinite steps(2,end); }

  .tear{
    position:absolute;
    left:-10%;
    right:-10%;
    height: 10%;
    top: 15%;
    opacity:0;
    background: linear-gradient(
      90deg,
      rgba(255,255,255,0),
      rgba(255,255,255,0.38),
      rgba(255,255,255,0)
    );
    filter: blur(1.2px);
    mix-blend-mode: screen;
    transform: translateX(0);
  }
  body.playing .tear{
    opacity: 0.50;
    animation: vhs-tear 0.22s infinite steps(2,end);
  }
  body.paused .tear{
    opacity: 0.55;
    transform: translateX(calc(var(--hx) * -1));
    animation: tear-hold 9s infinite steps(2,end);
  }

  .tear.t1{ top: var(--t1); }
  .tear.t2{ top: var(--t2); height: 8%; }
  .tear.t3{ top: var(--t3); height: 12%; }

  @keyframes vhs-track{ 0%{ transform: translateY(-10%); } 100%{ transform: translateY(780%); } }
  @keyframes vhs-noise{ 0%{ transform: translateX(0); filter:none; } 50%{ transform: translateX(-1.2px); filter: contrast(1.12); } 100%{ transform: translateX(0); filter:none; } }
  @keyframes vhs-global-jitter{ 0%{ transform: translate(0,0); } 25%{ transform: translate(-2px, 0); } 50%{ transform: translate( 2px,-1px); } 75%{ transform: translate(-1px, 1px); } 100%{ transform: translate(0,0); } }
  @keyframes vhs-vertical-float{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-2px); } }
  @keyframes vhs-tear{ 0%{ transform: translateX(-18px); } 50%{ transform: translateX( 22px); } 100%{ transform: translateX(-14px); } }
  @keyframes chroma-r{ 0%{ transform: translateX(-3px); } 50%{ transform: translateX(-5px); } 100%{ transform: translateX(-3px); } }
  @keyframes chroma-b{ 0%{ transform: translateX(3px); } 50%{ transform: translateX(6px); } 100%{ transform: translateX(3px); } }

  @keyframes vhs-hold-breathe{
    0%   { transform: translate3d(var(--hx), var(--hy), 0); }
    35%  { transform: translate3d(calc(var(--hx) + .55px), calc(var(--hy) - .35px), 0); }
    70%  { transform: translate3d(calc(var(--hx) - .45px), calc(var(--hy) + .25px), 0); }
    100% { transform: translate3d(var(--hx), var(--hy), 0); }
  }
  @keyframes vhs-hold-tick{
    0%   { filter: contrast(1.23) saturate(1.26) blur(var(--hblur)); }
    86%  { filter: contrast(1.23) saturate(1.26) blur(var(--hblur)); }
    90%  { filter: contrast(1.30) saturate(1.35) blur(calc(var(--hblur) + .25px)); }
    92%  { filter: contrast(1.23) saturate(1.26) blur(var(--hblur)); }
    100% { filter: contrast(1.23) saturate(1.26) blur(var(--hblur)); }
  }
  @keyframes vhs-track-hold{
    0%   { transform: translateY(0%); }
    88%  { transform: translateY(0%); }
    100% { transform: translateY(26%); }
  }
  @keyframes vhs-noise-hold{
    0%   { transform: translateX(0); filter:none; }
    40%  { transform: translateX(-.8px); filter: contrast(1.06); }
    80%  { transform: translateX(.7px); filter:none; }
    100% { transform: translateX(0); filter:none; }
  }
  @keyframes chroma-hold-r{
    0%   { transform: translateX(var(--hr)); }
    50%  { transform: translateX(calc(var(--hr) - .55px)); }
    100% { transform: translateX(var(--hr)); }
  }
  @keyframes chroma-hold-b{
    0%   { transform: translateX(var(--hb)); }
    50%  { transform: translateX(calc(var(--hb) + .65px)); }
    100% { transform: translateX(var(--hb)); }
  }
  @keyframes tear-hold{
    0%   { opacity:.52; }
    84%  { opacity:.52; }
    100% { opacity:.66; }
  }

  /* Controls */
  .controls{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:12px;
    margin: 10px 0 10px;
    flex-wrap:wrap;
  }

  button{
    border:none;
    width:52px;
    height:52px;
    padding:0;
    border-radius:999px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    background: rgba(0,255,0,.12);
    color: var(--ink);
    cursor:pointer;
    border:1px solid rgba(0,255,0,.25);
    transition:.18s ease;
    line-height:1;
  }

  button:hover{
    transform: translateY(-1px);
    border-color: rgba(0,255,0,.45);
    color: var(--neon);
  }

  /* ‚úÖ Hotspot: que NO cambie de posici√≥n al hover/active */
.tv-psy-hotspot{
  /* anulamos el estilo gen√©rico de button */
  background: transparent !important;
  border: 0 !important;
  box-shadow: none !important;
  transition: none !important;

  /* su transform base (centrado) */
  transform: translate(-50%,-50%) !important;
}

/* cuando pasas por encima o clicas, NO tocar posici√≥n */
.tv-psy-hotspot:hover,
.tv-psy-hotspot:active,
.tv-psy-hotspot:focus{
  transform: translate(-50%,-50%) !important;
}

/* evita que el :hover global lo ‚Äúsuba‚Äù */
.tv-psy-hotspot:hover{
  color: inherit !important;
}

/* el ‚Äúpunto‚Äù es el que anima, no el bot√≥n entero */
.tv-psy-hotspot::before{
  animation: tv-btn-flicker 1.05s steps(2,end) infinite;
  will-change: transform, opacity, filter;
}


  #play-pause{
    width:48px;
    height:48px;
    background: var(--neon);
    color:#000;
    border-color: rgba(0,255,0,0);
    box-shadow:0 0 22px rgba(0,255,0,.28);
  }
  #play-pause:hover{
    color:#000;
    box-shadow:0 0 34px rgba(0,255,0,.45);
  }

  #play-pause.pulse{ animation: pulse 1.35s ease-in-out infinite; }
  @keyframes pulse{
    0%,100%{ transform: translateY(0) scale(1); box-shadow:0 0 22px rgba(0,255,0,.28); }
    50%{ transform: translateY(-1px) scale(1.04); box-shadow:0 0 38px rgba(0,255,0,.45); }
  }

  .actions{
    display:flex;
    justify-content:center;
    gap:12px;
    flex-wrap:wrap;
    margin: 6px 0 6px;
  }
  .icon-btn{
    width:44px;
    height:44px;
    background: rgba(0,0,0,.25);
    color: var(--muted);
    border:1px solid rgba(255,255,255,.14);
    box-shadow:none;
  }
  .icon-btn:hover{ color: var(--neon); border-color: rgba(0,255,0,.35); }
  .icon-btn.on{
    background: rgba(0,255,0,.14);
    color: var(--neon);
    border-color: rgba(0,255,0,.45);
    box-shadow:0 0 18px rgba(0,255,0,.18);
  }

  .ico{
    width:22px;
    height:22px;
    fill:none;
    stroke:currentColor;
    stroke-width:2;
    stroke-linecap:round;
    stroke-linejoin:round;
  }
  #play-pause .ico{ width:22px; height:22px; stroke:#000; }

  #status-line{
    min-height:18px;
    font-size:12px;
    color:var(--muted);
    opacity:.9;
    margin: 8px 0 10px;
    letter-spacing:.06em;
  }

  /* Progress */
  .progress-wrapper{
    display:flex;
    align-items:center;
    justify-content:space-between;
    width:min(680px, 100%);
    margin: 0 auto;
    gap:10px;
  }

  .progress-container{
    flex:1;
    height:10px;
    background: rgba(255,255,255,0.10);
    border-radius:999px;
    cursor:pointer;
    overflow:visible;
    border:1px solid rgba(255,255,255,.10);
    position:relative;
    touch-action: none;
    user-select: none;
  }

  .progress-bar{
    width:0%;
    height:100%;
    border-radius:999px;
    background: linear-gradient(90deg, rgba(0,255,0,.35), rgba(0,255,0,.8), rgba(0,255,0,.35));
    background-size:400% 100%;
    animation: flow 4s linear infinite;
    transition: width 0.08s linear;
  }
  @keyframes flow{ 0%{background-position:0%} 100%{background-position:400%} }

  .progress-thumb{
    position:absolute;
    top:50%;
    left:0%;
    transform: translate(-50%, -50%);
    width:14px;
    height:14px;
    border-radius:999px;
    background: rgba(0,255,0,.95);
    box-shadow: 0 0 14px rgba(0,255,0,.35);
    border: 1px solid rgba(0,0,0,.35);
    pointer-events:none;
  }

  .seek-dot{
    position:absolute;
    top:50%;
    left:0%;
    transform: translate(-50%, -50%);
    width:10px;
    height:10px;
    border-radius:999px;
    background: rgba(255,255,255,.85);
    box-shadow: 0 0 10px rgba(0,0,0,.35);
    border: 1px solid rgba(0,0,0,.35);
    opacity:0;
    pointer-events:none;
  }

  .seek-tip{
    position:absolute;
    top:-30px;
    left:0%;
    transform: translate(-50%, 0);
    padding:6px 8px;
    font-size:12px;
    color: var(--ink);
    background: rgba(0,0,0,.55);
    border:1px solid rgba(255,255,255,.14);
    border-radius: 10px;
    letter-spacing:.04em;
    opacity:0;
    pointer-events:none;
    white-space:nowrap;
    backdrop-filter: blur(4px);
  }

  .progress-container.preview .seek-dot,
  .progress-container.preview .seek-tip{ opacity:1; }

  #current-time,#total-time{
    font-size:12px;
    color:var(--muted);
    min-width:46px;
    text-align:center;
  }

  /* Volume */
  .volume-wrapper{
    margin-top:16px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
  }
  .volume-icon{
    width:44px;
    height:44px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    border-radius:999px;
    background: rgba(0,0,0,.25);
    color: var(--muted);
    border:1px solid rgba(255,255,255,.14);
    cursor:pointer;
    transition:.18s ease;
  }
  .volume-icon:hover{
    color: var(--neon);
    border-color: rgba(0,255,0,.35);
    transform: translateY(-1px);
  }
  #volume-slider{
    width:160px;
    height:4px;
    cursor:pointer;
    accent-color: var(--neon);
  }

  /* ===== SUPPORT (CAF√â) ===== */
  .support{
    margin: 18px auto 10px;
    width: min(720px, 100%);
    text-align:center;
  }

  .support-btn{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 12px 18px;
    border-radius: 999px;
    border:1px solid rgba(0,255,0,.35);
    background: rgba(0,255,0,.10);
    color: var(--ink);
    cursor:pointer;
    transition:.18s ease;
    height:auto;
    width:auto;

    animation: neon-only 4.8s ease-in-out infinite;
    box-shadow: 0 0 14px rgba(0,255,0,.16);
  }

  @keyframes neon-only{
    0%, 70%, 100%{
      box-shadow: 0 0 14px rgba(0,255,0,.16);
      border-color: rgba(0,255,0,.40);
    }
    80%{
      box-shadow: 0 0 32px rgba(0,255,0,.34);
      border-color: rgba(0,255,0,.75);
    }
    90%{
      box-shadow: 0 0 18px rgba(0,255,0,.22);
      border-color: rgba(0,255,0,.50);
    }
  }

  .support-btn:hover{
    transform:none !important;
    border-color: rgba(0,255,0,.70);
    color: var(--neon);
    box-shadow: 0 0 28px rgba(0,255,0,.30);
  }
  .support-btn:active{ transform:none !important; }

  .support-note{
    margin-top:10px;
    font-size:12px;
    color: var(--muted);
    opacity:.9;
    letter-spacing:.03em;
  }

  .download-link{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    margin-top:10px;
    padding:10px 14px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.25);
    color: var(--muted);
    text-decoration:none;
    transition:.18s ease;
  }
  .download-link:hover{
    color: var(--neon);
    border-color: rgba(0,255,0,.35);
    box-shadow: 0 0 18px rgba(0,255,0,.16);
  }

  .download-note{
    margin-top:8px;
    font-size:12px;
    color: var(--muted);
    opacity:.9;
  }

  /* ===== MODAL ===== */
  .modal{
    position: fixed;
    inset: 0;
    display:none;
    align-items:center;
    justify-content:center;
    padding: 18px;
    background: rgba(0,0,0,.55);
    z-index: 999;
  }
  .modal.open{ display:flex; }

  .modal-card{
    width: min(560px, 100%);
    border-radius: 16px;
    background: rgba(10,8,8,.95);
    border: 1px solid rgba(255,255,255,.12);
    box-shadow: 0 0 34px rgba(0,0,0,.55);
    padding: 16px 16px 14px;
    text-align:left;
    position: relative;
  }

  .modal-close{
    position:absolute;
    top:10px;
    right:10px;

    width:48px !important;
    height:48px !important;
    padding:0 !important;

    border-radius:999px;
    background: rgba(255,255,255,.08) !important;
    border:1px solid rgba(255,255,255,.16) !important;

    display:flex;
    align-items:center;
    justify-content:center;

    cursor:pointer;
    color: var(--muted) !important;

    box-shadow:none !important;
    transform:none !important;

    z-index:5;
    pointer-events:auto;
    touch-action: manipulation;
  }
  .modal-close:hover{
    border-color: rgba(0,255,0,.45) !important;
    color: var(--neon) !important;
  }
  .modal-close svg{
    width:18px;
    height:18px;
    display:block;
    fill:none;
    stroke:currentColor;
    stroke-width:2.2;
    stroke-linecap:round;
    pointer-events:none !important;
  }

  .modal-title{
    font-size:14px;
    letter-spacing:.16em;
    text-transform:uppercase;
    color: var(--ink);
    opacity:.95;
    margin: 4px 0 8px;
  }

  .modal-text{
    font-size:13px;
    color: var(--muted);
    line-height:1.45;
    margin-bottom:12px;
  }

  .support-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:10px 12px;
    border-radius:12px;
    background: rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.08);
  }

  .support-label{
    font-size:12px;
    color: var(--muted);
    letter-spacing:.10em;
    text-transform:uppercase;
  }

  .support-value{
    font-size:13px;
    color: var(--ink);
    flex:1;
    text-align:center;
  }

  .copy-btn{
    padding: 10px 12px;
    border-radius: 999px;
    border:1px solid rgba(0,255,0,.28);
    background: rgba(0,255,0,.10);
    color: var(--ink);
    cursor:pointer;
    transition:.18s ease;
    white-space:nowrap;
    width:auto;
    height:auto;
  }
  .copy-btn:hover{
    color: var(--neon);
    border-color: rgba(0,255,0,.5);
  }

  /* Playlist */
  .playlist{
    margin:18px auto 0;
    text-align:left;
    width:min(720px, 100%);
  }
  .track{
    padding:10px 14px;
    border-radius:10px;
    background: rgba(255,255,255,0.05);
    margin:8px 0;
    transition: background 0.2s, transform 0.15s, border-color .2s;
    cursor:pointer;
    border:1px solid rgba(255,255,255,.08);
    color: var(--ink);
  }
  .track:hover{
    background: rgba(255,255,255,0.09);
    transform: translateY(-1px);
    border-color: rgba(0,255,0,.25);
  }
  .track.current{
    background: rgba(0,255,0,0.10);
    border-color: rgba(0,255,0,.45);
    color: var(--neon);
  }

  .sig{
    margin-top:16px;
    font-size:12px;
    opacity:.6;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:var(--muted);
  }

  @keyframes crt-flicker{
    0%{filter:brightness(1) contrast(1)}
    50%{filter:brightness(.97) contrast(1)}
    100%{filter:brightness(1) contrast(1)}
  }
  @keyframes crt-glitch{
    0%{transform:translate(0); filter:none}
    25%{transform:translate(-1px,0); filter:hue-rotate(-6deg)}
    50%{transform:translate(1px,0); filter:hue-rotate(6deg)}
    75%{transform:translate(-1px,0); filter:contrast(1.1)}
    100%{transform:translate(0); filter:none}
  }

  @media (max-width:480px){
    h1{ font-size:18px; }
    .subtitle{ font-size:15px; }
    .progress-wrapper{ gap:8px; }
    #volume-slider{ width: 140px; }

    /* En m√≥vil, un pel√≠n m√°s grande para el dedo sin reventar el dise√±o */
    :root{
      --psy-s: 12.6%;
    }
  }

  @media (prefers-reduced-motion: reduce){
    #cover{ animation:none !important; }
    .crt:hover #cover{ animation:none !important; }
    .progress-bar{ animation:none !important; }
    #play-pause.pulse{ animation:none !important; }
    .support-btn{ animation:none !important; }

    .subtitle, .subtitle::before, .subtitle::after{
      animation:none !important;
      transform:none !important;
      filter:none !important;
    }

    .vhs, .vhs::before, .vhs::after, .chroma, .tear{
      animation:none !important;
      opacity:0 !important;
    }

    .tv-psy-hotspot::before{ animation:none !important; }
    .tv-psy-hotspot::after{ animation:none !important; }
  }

  /* ===== FULLSCREEN GLITCH MODE ===== */
  .psy-overlay{
    position: fixed;
    inset: 0;
    z-index: 2500;
    display:none;
    background:#000;
    overflow:hidden;
    padding:
      calc(16px + env(safe-area-inset-top))
      calc(16px + env(safe-area-inset-right))
      calc(16px + env(safe-area-inset-bottom))
      calc(16px + env(safe-area-inset-left));
  }
  .psy-overlay.open{ display:block; }

  .psy-video{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
    background:#000;
    transform: translateZ(0) scale(1.02);
    filter: brightness(0.75) contrast(1.10) saturate(1.0);
  }

  /* PLAY: micro-zoom infinito */
  body.psy-open.playing #psy-video{
    animation: psy-zoom 14s linear infinite;
  }
  @keyframes psy-zoom{
    0%{ transform: scale(1.02) rotate(0.1deg); }
    100%{ transform: scale(1.10) rotate(0.1deg); }
  }

  .psy-noise{
    position:absolute;
    inset:0;
    pointer-events:none;
    mix-blend-mode: overlay;
    opacity: 0.22;
    background:
      repeating-linear-gradient(to bottom, rgba(255,255,255,.06) 0, rgba(255,255,255,.06) 1px, rgba(0,0,0,0) 3px),
      radial-gradient(circle at 20% 30%, rgba(0,255,0,.05), rgba(0,0,0,0) 55%),
      radial-gradient(circle at 80% 70%, rgba(0,120,255,.04), rgba(0,0,0,0) 60%);
    filter: blur(0.2px);
  }

  /* PAUSE: congelado + micro vida (B) */
  body.psy-open.paused .psy-noise{
    opacity: 0.34;
    animation: psy-hold-flicker 2.6s steps(2,end) infinite;
    filter: blur(0.35px) contrast(1.15);
  }
  @keyframes psy-hold-flicker{
    0%, 70%, 100%{ opacity:.28; }
    78%{ opacity:.42; }
    82%{ opacity:.30; }
    90%{ opacity:.46; }
  }

  .psy-tear{
    position:absolute;
    left:-10%;
    right:-10%;
    height: 14%;
    top: 14%;
    pointer-events:none;
    opacity:0;
    background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,0.28), rgba(255,255,255,0));
    filter: blur(1.2px);
    mix-blend-mode: screen;
    transform: translateX(0);
  }
  body.psy-open.paused .psy-tear{
    opacity: .55;
    animation: psy-tear-hold 7.4s steps(2,end) infinite;
  }
  @keyframes psy-tear-hold{
    0%, 84%{ transform: translateX(-10px); opacity:.46; }
    92%{ transform: translateX(14px); opacity:.62; }
    100%{ transform: translateX(-10px); opacity:.50; }
  }

  /* UI */
  .psy-ui{
    position:relative;
    height:100%;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
    gap:14px;
    pointer-events:none;
  }
  .psy-top, .psy-controls{ pointer-events:auto; }

  .psy-top{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap: 10px;
  }
  .psy-now{
    text-align:left;
    max-width: 78%;
    padding: 12px 14px;
    border-radius: 16px;
    background: rgba(0,0,0,.45);
    border:1px solid rgba(255,255,255,.14);
    backdrop-filter: blur(10px);
    box-shadow: 0 0 28px rgba(0,0,0,.55);
  }
  .psy-now .label{
    font-size:12px;
    letter-spacing:.14em;
    text-transform: uppercase;
    color: var(--muted);
    opacity:.95;
    margin-bottom: 6px;
  }
  .psy-now .title{
    font-size: 18px;
    letter-spacing:.06em;
    color: var(--ink);
    line-height:1.15;
    text-shadow: 0 0 18px rgba(255,255,255,.12);
  }

  .psy-top-actions{ display:flex; gap:10px; }

  .psy-icon{
    width:48px; height:48px;
    border-radius:999px;
    background: rgba(0,0,0,.45);
    border:1px solid rgba(255,255,255,.14);
    color: var(--muted);
    display:flex; align-items:center; justify-content:center;
    cursor:pointer;
    transition:.18s ease;
    backdrop-filter: blur(10px);
  }
  .psy-icon:hover{
    color: var(--neon);
    border-color: rgba(0,255,0,.35);
    box-shadow: 0 0 18px rgba(0,255,0,.14);
    transform:none !important;
  }
  .psy-icon .ico{ width:20px; height:20px; }

  .psy-controls{
    display:flex;
    justify-content:center;
    gap:16px;
    padding-bottom: 6px;
  }
  .psy-controls button{
    width:64px; height:64px;
    background: rgba(0,0,0,.35);
    border: 1px solid rgba(255,255,255,.16);
    color: var(--ink);
    box-shadow: 0 0 22px rgba(0,0,0,.45);
    backdrop-filter: blur(10px);
  }
  .psy-controls button:hover{ color: var(--neon); border-color: rgba(0,255,0,.35); }
  .psy-controls #psy-play-pause{
    background: rgba(0,255,0,.18);
    border-color: rgba(0,255,0,.28);
    box-shadow: 0 0 30px rgba(0,255,0,.16);
    color:#000;
  }
  .psy-controls #psy-play-pause .ico{ stroke:#000; }

  /* si NO hay m√∫sica (no cargado) -> negro total */
  body.psy-open:not(.playing):not(.paused) #psy-video{ opacity:0; }
  body.psy-open:not(.playing):not(.paused) .psy-noise{ opacity:0; }
  body.psy-open:not(.playing):not(.paused) .psy-tear{ opacity:0; }

  @media (max-width:480px){
    .psy-now .title{ font-size:16px; }
    .psy-controls button{ width:60px; height:60px; }
  }
</style>
</head>

<body>
  <main class="wrap">
    <a href="index.html" class="back">‚Üê HUYE! Sal corriendo...</a>

    <h1>Cosmic Marciana</h1>

    <div class="subtitle-wrap" aria-hidden="true">
      <div class="subtitle" id="subtitle" data-text="La casa del terror">La casa del terror</div>
    </div>

    <div class="crt" aria-hidden="true">
      <img id="cover" src="tv.webp" alt="Televisor CRT / portada" />

      <!-- ‚úÖ Bot√≥n redondo clicable (ne√≥n) -->
      <button class="tv-psy-hotspot" id="tv-psy-hotspot" type="button"
        aria-label="Abrir modo psicod√©lico" title="Abrir modo psicod√©lico"></button>

      <div class="tv-screen" aria-hidden="true">
        <div class="vhs">
          <div class="chroma r"></div>
          <div class="chroma b"></div>
          <div class="tear t1"></div>
          <div class="tear t2"></div>
          <div class="tear t3"></div>
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="prev-btn" aria-label="Anterior" title="Anterior"></button>
      <button id="play-pause" aria-label="Play/Pause" title="Play/Pause"></button>
      <button id="stop-btn" aria-label="Stop" title="Stop"></button>
      <button id="next-btn" aria-label="Siguiente" title="Siguiente"></button>
    </div>

    <div class="actions" aria-label="Acciones">
      <button id="shuffle-btn" class="icon-btn" aria-label="Shuffle" title="Shuffle"></button>
      <button id="loop-btn" class="icon-btn" aria-label="Loop" title="Loop"></button>
      <button id="share-btn" class="icon-btn" aria-label="Compartir" title="Compartir"></button>
      <!-- ‚úÖ Quitado bot√≥n "Modo psicod√©lico" -->
    </div>

    <div id="status-line"></div>

    <div class="progress-wrapper">
      <span id="current-time">0:00</span>
      <div class="progress-container" id="progress-container" aria-label="Barra de reproducci√≥n">
        <div class="progress-bar" id="progress-bar"></div>
        <div class="progress-thumb" id="progress-thumb"></div>
        <div class="seek-dot" id="seek-dot"></div>
        <div class="seek-tip" id="seek-tip">0:00</div>
      </div>
      <span id="total-time">0:00</span>
    </div>

    <div class="volume-wrapper">
      <span class="volume-icon" id="volume-icon" title="Mute" role="button" tabindex="0"></span>
      <input type="range" id="volume-slider" min="0" max="100" value="100" />
    </div>

    <div class="playlist" id="playlist">
      <div class="track" data-index="0">1. Noche sint√©tica</div>
      <div class="track" data-index="1">2. Volveremos a empezar</div>
      <div class="track" data-index="2">3. Qui√©n llena los shows</div>
      <div class="track" data-index="3">4. STOP!</div>
      <div class="track" data-index="4">5. Reza</div>
      <div class="track" data-index="5">6. De pie</div>
      <div class="track" data-index="6">7. Quemarlo todo</div>
      <div class="track" data-index="7">8. Nadie sabe nada</div>
      <div class="track" data-index="8">9. Lo que no quiero</div>
      <div class="track" data-index="9">10. La casa del terror</div>
      <div class="track" data-index="10">11. Tenemos que hablar</div>
    </div>

    <div class="support">
      <button class="support-btn" id="support-open" type="button">
        ¬øMe invitas a un caf√©? <span class="coffee" aria-hidden="true">‚òï</span>
      </button>

      <div class="support-note">
        Si te ha gustado la transmisi√≥n, la casa del terror es tuya si quieres: desc√°rgatela libremente.
      </div>
      <div class="download-note">
        Pero si me invitas a un caf√©, podr√© seguir emitiendo. En la casa del terror, en la de la risa o donde sea üíö
      </div>

      <a class="download-link" href="la-casa-del-terror.zip" download>
        ‚¨á Descargar el disco (ZIP)
      </a>
    </div>

    <div class="modal" id="support-modal" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true" aria-label="Colabora con Cosmic Marciana">
        <button class="modal-close" id="support-close" type="button" aria-label="Cerrar">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M6 6l12 12M18 6L6 18"></path>
          </svg>
        </button>

        <div class="modal-title">Apoya la transmisi√≥n</div>
        <div class="modal-text">
          Si este disco te ha acompa√±ado un rato, puedes invitarme a un caf√© v√≠a Bizum.
          <br><br>
          <strong>Gracias por sostener el ruido üíö</strong>
        </div>

        <div class="support-row">
          <div class="support-label">Bizum</div>
          <div class="support-value" id="bizum-number">+34 623 190 151</div>
          <button class="copy-btn" id="copy-bizum" type="button">Copiar</button>
        </div>
      </div>
    </div>

    <audio id="audio" preload="metadata" playsinline></audio>

    <div class="sig">EMISI√ìN NO AUTORIZADA ¬∑ NO MIRES ATR√ÅS!</div>
  </main>

  <!-- FULLSCREEN GLITCH MODE -->
  <div class="psy-overlay" id="psy-overlay" aria-hidden="true">
    <video id="psy-video" class="psy-video" muted loop playsinline preload="auto">
      <source src="glitch.mp4" type="video/mp4">
    </video>

    <div class="psy-noise" aria-hidden="true"></div>
    <div class="psy-tear" aria-hidden="true"></div>

    <div class="psy-ui">
      <div class="psy-top">
        <div class="psy-now" aria-live="polite">
          <div class="label">Est√° sonando</div>
          <div class="title" id="psy-track-title">‚Äî</div>
        </div>

        <div class="psy-top-actions">
          <button class="psy-icon" id="psy-fullscreen" type="button" aria-label="Pantalla completa" title="Pantalla completa"></button>
          <button class="psy-icon" id="psy-close" type="button" aria-label="Cerrar" title="Cerrar"></button>
        </div>
      </div>

      <div class="psy-controls" aria-label="Controles modo psicod√©lico">
        <button id="psy-prev" type="button" aria-label="Anterior" title="Anterior"></button>
        <button id="psy-play-pause" type="button" aria-label="Play/Pause" title="Play/Pause"></button>
        <button id="psy-next" type="button" aria-label="Siguiente" title="Siguiente"></button>
      </div>
    </div>
  </div>

<script>
  const ICONS = {
    prev: `<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 6v12"/><path d="M18 6l-8 6 8 6z"/></svg>`,
    next: `<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M18 6v12"/><path d="M6 6l8 6-8 6z"/></svg>`,
    stop: `<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><rect x="7" y="7" width="10" height="10" rx="1"/></svg>`,
    play: `<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M9 7l10 5-10 5z"/></svg>`,
    pause:`<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 6v12"/><path d="M16 6v12"/></svg>`,
    shuffle:`<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M16 3h5v5"/><path d="M4 20l7-7"/><path d="M4 4l7 7"/><path d="M21 16v5h-5"/><path d="M14 14l7 7"/><path d="M14 10l7-7"/></svg>`,
    loop:`<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M17 2l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 22l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>`,
    loop1:`<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M17 2l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 22l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/><path d="M12 8v8"/><path d="M11 9h2"/></svg>`,
    share:`<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 16V4"/><path d="M8 8l4-4 4 4"/><path d="M6 12v7a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-7"/></svg>`,
    vol3:`<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M11 5L6 9H3v6h3l5 4z"/><path d="M16 8a4 4 0 0 1 0 8"/><path d="M18.5 5.5a7 7 0 0 1 0 13"/></svg>`,
    vol2:`<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M11 5L6 9H3v6h3l5 4z"/><path d="M16 8a4 4 0 0 1 0 8"/></svg>`,
    mute:`<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M11 5L6 9H3v6h3l5 4z"/><path d="M16 9l5 6"/><path d="M21 9l-5 6"/></svg>`,
    close:`<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 6l12 12"/><path d="M18 6L6 18"/></svg>`,
    fullscreen:`<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M16 3h3a2 2 0 0 1 2 2v3"/><path d="M8 21H5a2 2 0 0 1-2-2v-3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>`,
    exitFullscreen:`<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 3v3a2 2 0 0 1-2 2H3"/><path d="M16 3v3a2 2 0 0 0 2 2h3"/><path d="M8 21v-3a2 2 0 0 0-2-2H3"/><path d="M16 21v-3a2 2 0 0 1 2-2h3"/></svg>`
  };

  const tvBase = "tv.webp";
  const tvByTrack = [
    "tv1.webp","tv2.webp","tv3.webp","tv4.webp","tv5.webp","tv6.webp",
    "tv7.webp","tv8.webp","tv9.webp","tv10.webp","tv11.webp"
  ];

  const sources = [
    "lospobres.mp3","vae.mp3","shows.mp3","STOP.mp3","reza.mp3",
    "depie.mp3","quemarlo.mp3","nadie.mp3","loque.mp3","lacasa.mp3","tenemos.mp3"
  ];

  const trackTitles = [
    "Noche sint√©tica","Volveremos a empezar","Qui√©n llena los shows","STOP!","Reza",
    "De pie","Quemarlo todo","Nadie sabe nada","Lo que no quiero","La casa del terror","Tenemos que hablar"
  ];

  const $ = (id) => document.getElementById(id);

  const coverImg = $("cover");
  const audio = $("audio");

  const progressContainer = $("progress-container");
  const progressBar = $("progress-bar");
  const progressThumb = $("progress-thumb");
  const seekDot = $("seek-dot");
  const seekTip = $("seek-tip");

  const currentTimeEl = $("current-time");
  const totalTimeEl = $("total-time");

  const volumeSlider = $("volume-slider");
  const volumeIcon = $("volume-icon");

  const statusLineEl = $("status-line");
  const shuffleBtn = $("shuffle-btn");
  const loopBtn = $("loop-btn");
  const playPauseBtn = $("play-pause");

  const prevBtn = $("prev-btn");
  const nextBtn = $("next-btn");
  const stopBtn = $("stop-btn");
  const shareBtn = $("share-btn");
  const playlistEl = $("playlist");
  const tracks = Array.from(document.querySelectorAll(".track"));

  // TV hotspot
  const tvPsyHotspot = $("tv-psy-hotspot");

  // PSY overlay
  const psyOverlay = $("psy-overlay");
  const psyVideo = $("psy-video");
  const psyTrackTitle = $("psy-track-title");
  const psyPrev = $("psy-prev");
  const psyNext = $("psy-next");
  const psyPlayPause = $("psy-play-pause");
  const psyClose = $("psy-close");
  const psyFullscreen = $("psy-fullscreen");

  let currentIndex = 0;
  let lastVolume = 1;
  let loopMode = 0; // 0=OFF,1=SONG,2=ALBUM
  let shuffleOn = false;
  let hasLoaded = false;

  let isScrubbing = false;
  let usingTouchFallback = false;
  let loadId = 0;

  const LS = {
    vol: "cm_vol",
    idx: "cm_idx",
    shuffle: "cm_shuffle",
    loop: "cm_loop",
    time: "cm_time"
  };

  // PRELOAD NEXT
  let preloader = null;
  let preloadedIndex = -1;

  function destroyPreloader(){
    if(!preloader) return;
    try{
      preloader.pause();
      preloader.removeAttribute("src");
      preloader.load();
    }catch{}
    preloader = null;
    preloadedIndex = -1;
  }

  function getNextIndexLinear(){ return (currentIndex + 1) % tracks.length; }

  function primePreload(index){
    if(index == null || index < 0 || index >= sources.length) return;
    if(shuffleOn) return;
    if(preloadedIndex === index && preloader) return;

    destroyPreloader();

    preloader = new Audio();
    preloader.preload = "auto";
    preloader.src = sources[index];
    preloadedIndex = index;

    try{ preloader.load(); } catch {}
  }

  function formatTime(t){
    const m = Math.floor(t / 60);
    const s = Math.floor(t % 60);
    return m + ":" + ("0" + s).slice(-2);
  }
  function clamp01(n){ return Math.max(0, Math.min(1, n)); }

  function setStatus(msg){
    statusLineEl.textContent = msg || "";
    if(msg){
      clearTimeout(setStatus._t);
      setStatus._t = setTimeout(()=>{ statusLineEl.textContent = ""; }, 1600);
    }
  }

  function tvForIndex(index){ return tvByTrack[index] || tvBase; }

  function renderIcons(){
    prevBtn.innerHTML = ICONS.prev;
    nextBtn.innerHTML = ICONS.next;
    stopBtn.innerHTML = ICONS.stop;
    shareBtn.innerHTML = ICONS.share;
    shuffleBtn.innerHTML = ICONS.shuffle;
    loopBtn.innerHTML = ICONS.loop;
    volumeIcon.innerHTML = ICONS.vol3;
    playPauseBtn.innerHTML = ICONS.play;

    psyPrev.innerHTML = ICONS.prev;
    psyNext.innerHTML = ICONS.next;
    psyPlayPause.innerHTML = ICONS.play;
    psyClose.innerHTML = ICONS.close;
    psyFullscreen.innerHTML = ICONS.fullscreen;
  }

  function setPsyTitle(){
    const title = trackTitles[currentIndex] || tracks[currentIndex]?.textContent || "‚Äî";
    psyTrackTitle.textContent = String(title).replace(/^\d+\.\s*/, "");
  }
  function setPsyPlayIcon(){ psyPlayPause.innerHTML = audio.paused ? ICONS.play : ICONS.pause; }

  function freezeVhsFrame(){
    const r = (min, max) => (min + Math.random() * (max - min));
    const root = document.documentElement;

    root.style.setProperty("--hx", `${r(-2.6, 2.6).toFixed(2)}px`);
    root.style.setProperty("--hy", `${r(-1.8, 1.8).toFixed(2)}px`);
    root.style.setProperty("--hblur", `${r(0.05, 0.55).toFixed(2)}px`);

    root.style.setProperty("--hr", `${r(-3.8, -1.4).toFixed(2)}px`);
    root.style.setProperty("--hb", `${r( 1.6,  4.2).toFixed(2)}px`);

    root.style.setProperty("--t1", `${r(10, 24).toFixed(1)}%`);
    root.style.setProperty("--t2", `${r(40, 58).toFixed(1)}%`);
    root.style.setProperty("--t3", `${r(64, 84).toFixed(1)}%`);
  }

  function clearVhsFrame(){
    const root = document.documentElement;
    root.style.setProperty("--hx", "0px");
    root.style.setProperty("--hy", "0px");
    root.style.setProperty("--hblur", "0.2px");
    root.style.setProperty("--hr", "-2.4px");
    root.style.setProperty("--hb", "2.8px");
    root.style.setProperty("--t1", "18%");
    root.style.setProperty("--t2", "50%");
    root.style.setProperty("--t3", "76%");
  }

  function setGlitchFromVolume(){
    const v = clamp01(audio.volume || 0);

    if(!hasLoaded){
      document.documentElement.style.setProperty("--g", "0");
      return;
    }

    if(audio.paused){
      const g = Math.max(0.22, Math.pow(0.10 + 0.90 * v, 1.15));
      document.documentElement.style.setProperty("--g", g.toFixed(3));
      return;
    }

    let g = Math.pow(0.10 + 0.90 * v, 1.6);
    if(v < 0.08) g = 0.12;
    document.documentElement.style.setProperty("--g", g.toFixed(3));
  }

  function setPlayingClass(){
    const isPlaying = hasLoaded && !audio.paused;
    const isPaused  = hasLoaded && audio.paused;

    document.body.classList.toggle("playing", isPlaying);
    document.body.classList.toggle("paused",  isPaused);

    if(isPaused) freezeVhsFrame();
    if(isPlaying) clearVhsFrame();

    setGlitchFromVolume();
    setPsyPlayIcon();
    syncPsyVideo();
  }

  function setPlayIcon(){
    playPauseBtn.innerHTML = audio.paused ? ICONS.play : ICONS.pause;
    playPauseBtn.classList.toggle("pulse", audio.paused);
    setPlayingClass();
  }

  function syncButtons(){
    shuffleBtn.classList.toggle("on", shuffleOn);
    loopBtn.classList.toggle("on", loopMode !== 0);

    if(loopMode === 0){
      loopBtn.innerHTML = ICONS.loop;
      loopBtn.title = "Loop OFF";
    } else if(loopMode === 1){
      loopBtn.innerHTML = ICONS.loop1;
      loopBtn.title = "Loop CANCI√ìN";
    } else {
      loopBtn.innerHTML = ICONS.loop;
      loopBtn.title = "Loop √ÅLBUM";
    }
  }

  function updateVolumeIcon(){
    if(audio.volume === 0) volumeIcon.innerHTML = ICONS.mute;
    else if(audio.volume < 0.5) volumeIcon.innerHTML = ICONS.vol2;
    else volumeIcon.innerHTML = ICONS.vol3;
  }

  function markCurrent(){
    tracks.forEach(t=>t.classList.remove("current"));
    const el = tracks[currentIndex];
    if(el) el.classList.add("current");
    setPsyTitle();
  }

  function resetProgressUI(){
    progressBar.style.width = "0%";
    progressThumb.style.left = "0%";
    currentTimeEl.textContent = "0:00";
    totalTimeEl.textContent = "0:00";
  }

  function setProgressUI(pct){
    const p = clamp01(pct);
    const perc = (p * 100);
    progressBar.style.width = perc + "%";
    progressThumb.style.left = perc + "%";
  }

  function getPctFromClientX(clientX){
    const rect = progressContainer.getBoundingClientRect();
    return clamp01((clientX - rect.left) / rect.width);
  }

  function seekToPct(pct){
    if(!audio.duration) return;
    audio.currentTime = clamp01(pct) * audio.duration;
  }

  function updatePreview(clientX){
    if(!audio.duration) return;
    const pct = getPctFromClientX(clientX);
    const perc = pct * 100;
    seekDot.style.left = perc + "%";
    seekTip.style.left = perc + "%";
    seekTip.textContent = formatTime(pct * audio.duration);
  }

  function showPreview(){ progressContainer.classList.add("preview"); }
  function hidePreview(){ progressContainer.classList.remove("preview"); }

  // SCRUBBING RAF
  let pendingSeekPct = null;
  let rafSeekId = 0;

  function requestSeek(pct){
    pendingSeekPct = clamp01(pct);
    if(rafSeekId) return;

    rafSeekId = requestAnimationFrame(() => {
      rafSeekId = 0;
      if(pendingSeekPct == null) return;
      seekToPct(pendingSeekPct);
      pendingSeekPct = null;
    });
  }

  function cancelSeekRAF(){
    if(rafSeekId){
      cancelAnimationFrame(rafSeekId);
      rafSeekId = 0;
    }
    pendingSeekPct = null;
  }

  function onPointerDown(e){
    e.preventDefault();
    if(!audio.duration) return;
    isScrubbing = true;
    usingTouchFallback = false;
    try { progressContainer.setPointerCapture(e.pointerId); } catch {}
    showPreview();
    updatePreview(e.clientX);
    requestSeek(getPctFromClientX(e.clientX));
  }

  function onPointerMove(e){
    e.preventDefault();
    if(!audio.duration) return;
    if(usingTouchFallback) return;
    showPreview();
    updatePreview(e.clientX);
    if(isScrubbing) requestSeek(getPctFromClientX(e.clientX));
  }

  function onPointerUp(e){
    if(!audio.duration) return;
    if(usingTouchFallback) return;
    isScrubbing = false;
    cancelSeekRAF();
    try { progressContainer.releasePointerCapture(e.pointerId); } catch {}
    hidePreview();
  }

  function touchClientX(ev){
    const t = ev.touches && ev.touches[0] ? ev.touches[0] : (ev.changedTouches ? ev.changedTouches[0] : null);
    return t ? t.clientX : null;
  }

  function onTouchStart(ev){
    if(!audio.duration) return;
    usingTouchFallback = true;
    isScrubbing = true;
    ev.preventDefault();

    const cx = touchClientX(ev);
    if(cx == null) return;
    showPreview();
    updatePreview(cx);
    requestSeek(getPctFromClientX(cx));
  }

  function onTouchMove(ev){
    if(!audio.duration) return;
    if(!isScrubbing) return;
    ev.preventDefault();

    const cx = touchClientX(ev);
    if(cx == null) return;
    showPreview();
    updatePreview(cx);
    requestSeek(getPctFromClientX(cx));
  }

  function onTouchEnd(ev){
    if(!audio.duration) return;
    ev.preventDefault();
    isScrubbing = false;
    cancelSeekRAF();
    hidePreview();
  }

  function endScrub(){
    if(!isScrubbing) return;
    isScrubbing = false;
    cancelSeekRAF();
    hidePreview();
  }

  // Continuar autom√°tico donde lo dejaste
  function saveCurrentTime(){
    if(!hasLoaded) return;
    try{
      const t = Number(audio.currentTime || 0);
      localStorage.setItem(LS.time, String(Math.max(0, t)));
    }catch{}
  }
  function clearSavedTime(){
    try{ localStorage.removeItem(LS.time); }catch{}
  }

  function applyResumeTimeIfAny(){
    const t = Number(localStorage.getItem(LS.time));
    if(!Number.isFinite(t) || t <= 0) return;

    loadTrack(currentIndex);

    const resume = () => {
      audio.removeEventListener("loadedmetadata", resume);
      if(audio.duration && t < (audio.duration - 0.25)){
        try{ audio.currentTime = t; }catch{}
        currentTimeEl.textContent = formatTime(t);
        setProgressUI(audio.duration ? (t / audio.duration) : 0);
        setStatus("Continuando donde lo dejaste‚Ä¶");
      } else {
        clearSavedTime();
      }
    };
    audio.addEventListener("loadedmetadata", resume);
  }

  // PSY video sync (freeze real)
  function ensurePsyVideoReady(){
    if(!psyVideo) return;
    psyVideo.muted = true;
    psyVideo.loop = true;
    psyVideo.playsInline = true;
  }

  function syncPsyVideo(){
    if(!psyOverlay.classList.contains("open")) return;
    if(!psyVideo) return;

    if(!hasLoaded || !audio.src){
      try{ psyVideo.pause(); }catch{}
      return;
    }

    if(!audio.paused){
      psyVideo.play().catch(()=>{});
    } else {
      psyVideo.pause();
    }
  }

  function loadTrack(index){
    currentIndex = index;

    coverImg.src = tvForIndex(index);
    markCurrent();

    localStorage.setItem(LS.idx, String(currentIndex));

    audio.pause();
    try { audio.currentTime = 0; } catch {}
    audio.src = sources[index];
    audio.load();

    hasLoaded = true;
    setPlayingClass();

    primePreload(getNextIndexLinear());
  }

  async function waitCanPlay(){
    if(audio.readyState >= 3) return;
    await new Promise((resolve, reject)=>{
      const onCanPlay = ()=>{ cleanup(); resolve(); };
      const onError = ()=>{ cleanup(); reject(new Error("audio error")); };
      const cleanup = ()=>{
        audio.removeEventListener("canplay", onCanPlay);
        audio.removeEventListener("error", onError);
      };
      audio.addEventListener("canplay", onCanPlay, { once:true });
      audio.addEventListener("error", onError, { once:true });
    });
  }

  async function playCurrent(){
    if(!hasLoaded) loadTrack(currentIndex);

    const myId = ++loadId;

    try{
      await waitCanPlay();
      if(myId !== loadId) return;

      await audio.play();
      if(myId !== loadId) return;

      setPlayIcon();
    } catch(e){
      setPlayIcon();
      setStatus("Pulsa Play para iniciar.");
    }
  }

  function playTrack(index){
    loadTrack(index);
    playCurrent();
  }

  function togglePlay(){
    if(audio.paused) playCurrent();
    else{
      audio.pause();
      setPlayIcon();
    }
  }

  function stopTrack(){
    ++loadId;
    cancelSeekRAF();
    clearSavedTime();

    audio.pause();
    try { audio.currentTime = 0; } catch {}
    audio.removeAttribute("src");
    audio.load();

    hasLoaded = false;

    coverImg.src = tvBase;
    tracks.forEach(t => t.classList.remove("current"));
    currentIndex = 0;

    localStorage.setItem(LS.idx, "0");

    destroyPreloader();

    resetProgressUI();
    clearVhsFrame();
    setPlayIcon();

    document.documentElement.style.setProperty("--g", "0");
    setPsyTitle();

    try{ psyVideo.pause(); }catch{}
  }

  function getRandomNextIndex(){
    if(tracks.length <= 1) return currentIndex;
    let n = currentIndex;
    while(n === currentIndex) n = Math.floor(Math.random() * tracks.length);
    return n;
  }

  function nextTrack(){
    if(shuffleOn) return playTrack(getRandomNextIndex());
    playTrack((currentIndex + 1) % tracks.length);
  }

  function prevTrack(){
    if(shuffleOn) return playTrack(getRandomNextIndex());
    playTrack((currentIndex - 1 + tracks.length) % tracks.length);
  }

  function toggleShuffle(){
    shuffleOn = !shuffleOn;
    localStorage.setItem(LS.shuffle, shuffleOn ? "1" : "0");
    syncButtons();
    setStatus(shuffleOn ? "Shuffle ON" : "Shuffle OFF");

    if(!shuffleOn) primePreload(getNextIndexLinear());
    else destroyPreloader();
  }

  function cycleLoop(){
    loopMode = (loopMode + 1) % 3;
    localStorage.setItem(LS.loop, String(loopMode));
    syncButtons();
    setStatus(loopMode === 0 ? "Loop OFF" : (loopMode === 1 ? "Loop CANCI√ìN" : "Loop √ÅLBUM"));
  }

  async function sharePage(){
    const url = window.location.href;

    try{
      if(navigator.share){
        await navigator.share({ title: "Cosmic Marciana", url });
        setStatus("Compartido üíö");
        return;
      }
    } catch {}

    try{
      if(navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(url);
        setStatus("Link copiado üíö");
        return;
      }
    } catch {}

    window.prompt("Copia este link:", url);
  }

  function applyStoredSettings(){
    const v = Number(localStorage.getItem(LS.vol));
    if(Number.isFinite(v) && v >= 0 && v <= 1){
      audio.volume = v;
      volumeSlider.value = String(Math.round(v * 100));
      lastVolume = v || 1;
    } else {
      audio.volume = 1;
      volumeSlider.value = "100";
      lastVolume = 1;
    }

    const idx = Number(localStorage.getItem(LS.idx));
    if(Number.isInteger(idx) && idx >= 0 && idx < sources.length){
      currentIndex = idx;
    } else {
      currentIndex = 0;
    }

    shuffleOn = localStorage.getItem(LS.shuffle) === "1";
    const lm = Number(localStorage.getItem(LS.loop));
    loopMode = (lm === 0 || lm === 1 || lm === 2) ? lm : 0;

    updateVolumeIcon();
    syncButtons();

    coverImg.src = tvBase;
    setPlayIcon();
    resetProgressUI();
    markCurrent();

    if(!shuffleOn) primePreload(getNextIndexLinear());
    else destroyPreloader();

    setGlitchFromVolume();
  }

  function openPsy(){
    ensurePsyVideoReady();
    psyOverlay.classList.add("open");
    psyOverlay.setAttribute("aria-hidden","false");
    document.body.classList.add("psy-open");
    setPsyTitle();
    setPsyPlayIcon();

    psyClose.focus();
    syncPsyVideo();

    if(hasLoaded && !audio.paused){
      psyVideo.play().catch(()=>{});
    }
  }

  function closePsy(){
    psyOverlay.classList.remove("open");
    psyOverlay.setAttribute("aria-hidden","true");
    document.body.classList.remove("psy-open");
    if(document.fullscreenElement){
      document.exitFullscreen().catch(()=>{});
    }
    tvPsyHotspot.focus();
  }

  function isFullscreen(){ return !!document.fullscreenElement; }
  function updateFullscreenIcon(){ psyFullscreen.innerHTML = isFullscreen() ? ICONS.exitFullscreen : ICONS.fullscreen; }

  async function toggleFullscreen(){
    try{
      if(!isFullscreen()) await psyOverlay.requestFullscreen();
      else await document.exitFullscreen();
    }catch{}
    updateFullscreenIcon();
  }

  function wireEvents(){
    prevBtn.addEventListener("click", prevTrack);
    nextBtn.addEventListener("click", nextTrack);
    playPauseBtn.addEventListener("click", togglePlay);
    stopBtn.addEventListener("click", stopTrack);
    shuffleBtn.addEventListener("click", toggleShuffle);
    loopBtn.addEventListener("click", cycleLoop);
    shareBtn.addEventListener("click", sharePage);

    playlistEl.addEventListener("click", (e)=>{
      const item = e.target.closest(".track");
      if(!item) return;
      const idx = Number(item.dataset.index);
      if(!Number.isInteger(idx)) return;

      if(idx === currentIndex && hasLoaded){
        togglePlay();
        return;
      }
      playTrack(idx);
    });

    progressContainer.addEventListener("pointerdown", onPointerDown, { passive:false });
    progressContainer.addEventListener("pointermove", onPointerMove, { passive:false });
    progressContainer.addEventListener("pointerup", onPointerUp);
    progressContainer.addEventListener("pointercancel", onPointerUp);

    progressContainer.addEventListener("touchstart", onTouchStart, { passive:false });
    progressContainer.addEventListener("touchmove", onTouchMove, { passive:false });
    progressContainer.addEventListener("touchend", onTouchEnd, { passive:false });
    progressContainer.addEventListener("touchcancel", onTouchEnd, { passive:false });

    progressContainer.addEventListener("pointerenter", ()=> { if(audio.duration) showPreview(); });
    progressContainer.addEventListener("pointerleave", ()=> { if(!isScrubbing) hidePreview(); });

    document.addEventListener("pointerup", endScrub, { passive:true });
    document.addEventListener("pointercancel", endScrub, { passive:true });
    document.addEventListener("touchend", endScrub, { passive:true });
    document.addEventListener("touchcancel", endScrub, { passive:true });

    audio.addEventListener("timeupdate", ()=>{
      if(!audio.duration) return;
      currentTimeEl.textContent = formatTime(audio.currentTime);
      totalTimeEl.textContent = formatTime(audio.duration);
      setProgressUI(audio.currentTime / audio.duration);
      saveCurrentTime();
    });

    audio.addEventListener("loadedmetadata", ()=>{
      if(audio.duration) totalTimeEl.textContent = formatTime(audio.duration);
    });

    audio.addEventListener("ended", ()=>{
      clearSavedTime();

      if(loopMode === 1) return playTrack(currentIndex);
      if(loopMode === 2) return nextTrack();
      if(shuffleOn) return nextTrack();

      if(currentIndex === tracks.length - 1){
        stopTrack();
        setStatus("Final del disco.");
      } else {
        nextTrack();
      }
    });

    audio.addEventListener("error", ()=>{
      setStatus("Error cargando audio.");
      setPlayIcon();
    });

    audio.addEventListener("play", setPlayingClass);
    audio.addEventListener("pause", setPlayingClass);
    audio.addEventListener("ended", setPlayingClass);
    audio.addEventListener("volumechange", setGlitchFromVolume);

    volumeSlider.addEventListener("input", ()=>{
      const v = Number(volumeSlider.value) / 100;
      audio.volume = v;
      lastVolume = v || lastVolume;
      localStorage.setItem(LS.vol, String(v));
      updateVolumeIcon();
      setGlitchFromVolume();
    });

    volumeIcon.addEventListener("click", ()=>{
      if(audio.volume > 0){
        lastVolume = audio.volume;
        audio.volume = 0;
        volumeSlider.value = "0";
      } else {
        audio.volume = lastVolume || 1;
        volumeSlider.value = String(Math.round(audio.volume * 100));
      }
      localStorage.setItem(LS.vol, String(audio.volume));
      updateVolumeIcon();
      setGlitchFromVolume();
    });

    volumeIcon.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        volumeIcon.click();
      }
    });

    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && psyOverlay.classList.contains("open") && !document.fullscreenElement){
        e.preventDefault();
        closePsy();
        return;
      }

      if(e.code === "Space"){
        if(document.activeElement && document.activeElement.tagName === "INPUT") return;
        e.preventDefault();
        togglePlay();
      }
      if(e.code === "ArrowRight") nextTrack();
      if(e.code === "ArrowLeft") prevTrack();
    });

    document.addEventListener("visibilitychange", ()=>{
      if(document.hidden){
        if(!audio.paused){
          audio.pause();
          setPlayIcon();
        }
      }
    });

    // ‚úÖ ABRIR MODO: click en el bot√≥n redondo de la tele
    tvPsyHotspot.addEventListener("click", openPsy);

    // PSY overlay
    psyClose.addEventListener("click", closePsy);
    psyFullscreen.addEventListener("click", toggleFullscreen);
    psyPrev.addEventListener("click", prevTrack);
    psyNext.addEventListener("click", nextTrack);
    psyPlayPause.addEventListener("click", togglePlay);

    document.addEventListener("fullscreenchange", updateFullscreenIcon);
  }

  function supportInit(){
    const openBtn = document.getElementById("support-open");
    const modal = document.getElementById("support-modal");
    const closeBtn = document.getElementById("support-close");
    const copyBtn = document.getElementById("copy-bizum");
    const bizumEl = document.getElementById("bizum-number");

    if(!openBtn || !modal || !closeBtn) return;

    function open(){
      modal.classList.add("open");
      modal.setAttribute("aria-hidden","false");
      closeBtn.focus();
    }
    function close(){
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden","true");
      openBtn.focus();
    }

    openBtn.addEventListener("click", open);
    closeBtn.addEventListener("click", close);

    modal.addEventListener("click", (e)=>{
      if(e.target === modal) close();
    });

    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && modal.classList.contains("open")) close();
    });

    copyBtn?.addEventListener("click", async ()=>{
      const txt = (bizumEl?.textContent || "").trim();
      if(!txt) return;

      try{
        if(navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(txt);
          copyBtn.textContent = "Copiado";
          setTimeout(()=> copyBtn.textContent = "Copiar", 900);
          return;
        }
      } catch {}

      window.prompt("Copia este Bizum:", txt);
    });
  }

  (function init(){
    renderIcons();
    applyStoredSettings();
    wireEvents();
    supportInit();
    updateFullscreenIcon();
    setPsyTitle();
    applyResumeTimeIfAny();
    ensurePsyVideoReady();
  })();
</script>

</body>
</html>




