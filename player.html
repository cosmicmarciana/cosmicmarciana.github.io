<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>La casa del terror</title>

<style>
  :root{
    --neon:#00ff00;
    --ink:#eaeaea;
    --muted:#cfcfcf;
    --blood:#ff2b2b;
  }
  *{ box-sizing:border-box; }
  html,body{ margin:0; padding:0; background:#050303; color:var(--ink); font-family:Arial,sans-serif; }
  body{ min-height:100vh; display:flex; justify-content:center; padding:24px 14px; }
  .wrap{ width:100%; max-width:820px; text-align:center; }
  a{ color:var(--ink); text-decoration:none; opacity:.8; }
  a:hover{ color:var(--neon); opacity:1; }

  h1{
    margin: 10px 0 6px 0;
    font-size: 22px;
    letter-spacing: .22em;
    font-weight: 800;
    text-transform: uppercase;
    opacity: .95;
  }
  .subtitle{
    margin: 0 0 10px 0;
    font-size: 18px;
    letter-spacing: .22em;
    font-weight: 800;
    text-transform: uppercase;
    color: var(--blood);
    opacity: .95;
  }

  .controls{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:10px;
    margin: 10px 0 10px;
    flex-wrap:wrap;
  }

  button{
    border:none;
    width:52px;
    height:52px;
    padding:0;
    border-radius:999px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    background: rgba(0,255,0,.10);
    color: var(--ink);
    cursor:pointer;
    border:1px solid rgba(0,255,0,.25);
    transition:.18s ease;
    line-height:1;
  }
  button:hover{ transform: translateY(-1px); border-color: rgba(0,255,0,.55); color: var(--neon); }

  #play-pause{
    width:48px;
    height:48px;
    background: var(--neon);
    color:#000;
    border-color: rgba(0,255,0,0);
    box-shadow:0 0 22px rgba(0,255,0,.20);
  }
  #play-pause svg{ stroke:#000 !important; }

  .ico{ width:22px; height:22px; fill:none; stroke:currentColor; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }

  .progress-wrapper{
    display:flex;
    align-items:center;
    justify-content:space-between;
    width:min(680px, 100%);
    margin: 8px auto 0;
    gap:10px;
    color:var(--muted);
    font-size:12px;
  }
  .progress-container{
    flex:1;
    height:10px;
    background: rgba(255,255,255,0.10);
    border-radius:999px;
    cursor:pointer;
    border:1px solid rgba(255,255,255,.10);
    position:relative;
    touch-action:none;
    user-select:none;
  }
  .progress-bar{
    width:0%;
    height:100%;
    border-radius:999px;
    background: linear-gradient(90deg, rgba(0,255,0,.35), rgba(0,255,0,.8), rgba(0,255,0,.35));
    background-size:400% 100%;
    animation: flow 4s linear infinite;
  }
  @keyframes flow{ 0%{background-position:0%} 100%{background-position:400%} }
  .thumb{
    position:absolute;
    top:50%;
    left:0%;
    transform: translate(-50%, -50%);
    width:14px;
    height:14px;
    border-radius:999px;
    background: rgba(0,255,0,.95);
    box-shadow: 0 0 14px rgba(0,255,0,.25);
    border: 1px solid rgba(0,0,0,.35);
    pointer-events:none;
  }

  .volume{
    margin: 14px auto 0;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
  }
  #volume-slider{ width:160px; accent-color: var(--neon); }

  .playlist{
    margin:16px auto 0;
    text-align:left;
    width:min(720px, 100%);
  }
  .track{
    padding:10px 14px;
    border-radius:10px;
    background: rgba(255,255,255,0.05);
    margin:8px 0;
    transition: .18s ease;
    cursor:pointer;
    border:1px solid rgba(255,255,255,.08);
    color: var(--ink);
  }
  .track:hover{ background: rgba(255,255,255,0.09); border-color: rgba(0,255,0,.25); transform: translateY(-1px); }
  .track.current{ background: rgba(0,255,0,0.10); border-color: rgba(0,255,0,.45); color: var(--neon); }

  /* ===== PSY OVERLAY ===== */
  body.psy-open{ overflow:hidden; }

  .psy{
    position: fixed;
    inset: 0;
    z-index: 9999;
    background:#000;
    display:none;
  }
  .psy.open{ display:block; }
  .psy canvas{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    display:block;
  }

  .psy-ui{
    position:absolute;
    left: 14px;
    right: 14px;
    top: calc(14px + env(safe-area-inset-top));
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    pointer-events:none;
  }
  .psy-chip{
    pointer-events:auto;
    padding: 10px 12px;
    border-radius: 999px;
    background: rgba(0,0,0,.55);
    border: 1px solid rgba(255,255,255,.14);
    color: var(--muted);
    font-size: 12px;
    letter-spacing:.04em;
    backdrop-filter: blur(6px);
    max-width: 74vw;
    white-space: nowrap;
    overflow:hidden;
    text-overflow: ellipsis;
  }
  .psy-close{
    pointer-events:auto;
    width:auto !important;
    height:auto !important;
    padding: 10px 12px !important;
    border-radius: 999px !important;
    background: rgba(255,255,255,.10) !important;
    border: 1px solid rgba(255,255,255,.16) !important;
    color: var(--muted) !important;
  }
  .psy-close:hover{ border-color: rgba(0,255,0,.55) !important; color: var(--neon) !important; }

  .psy-bar{
    position:absolute;
    left: 14px;
    right: 14px;
    bottom: calc(14px + env(safe-area-inset-bottom));
    display:flex;
    justify-content:center;
    gap:10px;
    pointer-events:none;
  }
  .psy-ctrl{
    pointer-events:auto;
    width:44px;
    height:44px;
    border-radius:999px;
    border:1px solid rgba(0,255,0,.22);
    background: rgba(0,0,0,.35);
    color: var(--ink);
    backdrop-filter: blur(6px);
  }
  .psy-ctrl:hover{ border-color: rgba(0,255,0,.55); color: var(--neon); }
  .psy-main{
    width:50px;
    height:50px;
    background: rgba(0,255,0,.14);
    border-color: rgba(0,255,0,.35);
  }
</style>
</head>

<body>
  <main class="wrap">
    <a href="index.html">← HUYE! Sal corriendo...</a>

    <h1>Cosmic Marciana</h1>
    <div class="subtitle">La casa del terror</div>

    <div class="controls">
      <button id="prev-btn" title="Anterior"></button>
      <button id="play-pause" title="Play/Pause"></button>
      <button id="next-btn" title="Siguiente"></button>
    </div>

    <div class="progress-wrapper">
      <span id="current-time">0:00</span>
      <div class="progress-container" id="progress-container">
        <div class="progress-bar" id="progress-bar"></div>
        <div class="thumb" id="progress-thumb"></div>
      </div>
      <span id="total-time">0:00</span>
    </div>

    <div class="volume">
      <span style="color:var(--muted);font-size:12px;letter-spacing:.06em;">VOL</span>
      <input type="range" id="volume-slider" min="0" max="100" value="100" />
    </div>

    <div class="playlist" id="playlist">
      <div class="track" data-index="0">1. Noche sintética</div>
      <div class="track" data-index="1">2. Volveremos a empezar</div>
      <div class="track" data-index="2">3. Quién llena los shows</div>
      <div class="track" data-index="3">4. STOP!</div>
      <div class="track" data-index="4">5. Reza</div>
      <div class="track" data-index="5">6. De pie</div>
      <div class="track" data-index="6">7. Quemarlo todo</div>
      <div class="track" data-index="7">8. Nadie sabe nada</div>
      <div class="track" data-index="8">9. Lo que no quiero</div>
      <div class="track" data-index="9">10. La casa del terror</div>
      <div class="track" data-index="10">11. Tenemos que hablar</div>
    </div>

    <audio id="audio" preload="metadata" playsinline></audio>

    <!-- PSY -->
    <section class="psy open" id="psy" aria-hidden="false">
      <canvas id="psy-canvas"></canvas>
      <div class="psy-ui">
        <div class="psy-chip" id="psy-now">está sonando: —</div>
        <button class="psy-close" id="psy-close" type="button" title="Cerrar">✕</button>
      </div>
      <div class="psy-bar">
        <button class="psy-ctrl" id="psy-prev" title="Anterior"></button>
        <button class="psy-ctrl psy-main" id="psy-play" title="Play/Pause"></button>
        <button class="psy-ctrl" id="psy-next" title="Siguiente"></button>
      </div>
    </section>
  </main>

<script>
  // ===== ICONS =====
  const ICONS = {
    prev: `<svg class="ico" viewBox="0 0 24 24"><path d="M6 6v12"/><path d="M18 6l-8 6 8 6z"/></svg>`,
    next: `<svg class="ico" viewBox="0 0 24 24"><path d="M18 6v12"/><path d="M6 6l8 6-8 6z"/></svg>`,
    play: `<svg class="ico" viewBox="0 0 24 24"><path d="M9 7l10 5-10 5z"/></svg>`,
    pause:`<svg class="ico" viewBox="0 0 24 24"><path d="M8 6v12"/><path d="M16 6v12"/></svg>`
  };

  const sources = [
    "lospobres.mp3","vae.mp3","shows.mp3","STOP.mp3","reza.mp3",
    "depie.mp3","quemarlo.mp3","nadie.mp3","loque.mp3","lacasa.mp3","tenemos.mp3"
  ];

  const $ = (id)=>document.getElementById(id);

  const audio = $("audio");
  const tracks = Array.from(document.querySelectorAll(".track"));
  const playlistEl = $("playlist");

  const prevBtn = $("prev-btn");
  const nextBtn = $("next-btn");
  const playPauseBtn = $("play-pause");

  const progressContainer = $("progress-container");
  const progressBar = $("progress-bar");
  const progressThumb = $("progress-thumb");
  const currentTimeEl = $("current-time");
  const totalTimeEl = $("total-time");

  const volumeSlider = $("volume-slider");

  // PSY UI
  const psyEl = $("psy");
  const psyCanvas = $("psy-canvas");
  const psyNow = $("psy-now");
  const psyClose = $("psy-close");
  const psyPrev = $("psy-prev");
  const psyPlay = $("psy-play");
  const psyNext = $("psy-next");

  prevBtn.innerHTML = ICONS.prev;
  nextBtn.innerHTML = ICONS.next;
  playPauseBtn.innerHTML = ICONS.play;

  psyPrev.innerHTML = ICONS.prev;
  psyNext.innerHTML = ICONS.next;
  psyPlay.innerHTML = ICONS.play;

  let currentIndex = 0;
  let hasLoaded = false;

  function fmt(t){
    const m = Math.floor(t/60);
    const s = Math.floor(t%60);
    return m + ":" + ("0"+s).slice(-2);
  }
  function clamp01(n){ return Math.max(0, Math.min(1, n)); }

  function trackLabel(){
    const raw = (tracks[currentIndex]?.textContent || "").trim();
    return raw.replace(/^\d+\.\s*/, "") || "—";
  }
  function updateNow(){
    if(!hasLoaded){
      psyNow.textContent = "está sonando: —";
      return;
    }
    const time = audio.duration ? `${fmt(audio.currentTime)} / ${fmt(audio.duration)}` : fmt(audio.currentTime||0);
    psyNow.textContent = `está sonando: ${trackLabel()} · ${time}`;
  }
  function markCurrent(){
    tracks.forEach(t=>t.classList.remove("current"));
    tracks[currentIndex]?.classList.add("current");
  }
  function setPlayIcons(){
    const paused = (!hasLoaded) || audio.paused;
    playPauseBtn.innerHTML = paused ? ICONS.play : ICONS.pause;
    psyPlay.innerHTML = paused ? ICONS.play : ICONS.pause;
  }

  function loadTrack(i){
    currentIndex = i;
    audio.pause();
    try{ audio.currentTime = 0; }catch{}
    audio.src = sources[currentIndex];
    audio.load();
    hasLoaded = true;
    markCurrent();
    updateNow();
    setPlayIcons();
  }

  async function playCurrent(){
    if(!hasLoaded) loadTrack(currentIndex);
    try{
      await audio.play();
    }catch{}
    setPlayIcons();
    updateNow();
  }

  function togglePlay(){
    if(!hasLoaded) return playCurrent();
    if(audio.paused) return playCurrent();
    audio.pause();
    setPlayIcons();
    updateNow();
  }

  function nextTrack(){
    const n = (currentIndex + 1) % tracks.length;
    loadTrack(n);
    playCurrent();
  }
  function prevTrack(){
    const p = (currentIndex - 1 + tracks.length) % tracks.length;
    loadTrack(p);
    playCurrent();
  }

  prevBtn.addEventListener("click", prevTrack);
  nextBtn.addEventListener("click", nextTrack);
  playPauseBtn.addEventListener("click", togglePlay);

  psyPrev.addEventListener("click", prevTrack);
  psyNext.addEventListener("click", nextTrack);
  psyPlay.addEventListener("click", togglePlay);

  playlistEl.addEventListener("click", (e)=>{
    const item = e.target.closest(".track");
    if(!item) return;
    const idx = Number(item.dataset.index);
    if(!Number.isInteger(idx)) return;
    if(idx === currentIndex && hasLoaded) return togglePlay();
    loadTrack(idx);
    playCurrent();
  });

  // progress
  function setProgress(pct){
    const p = clamp01(pct);
    const perc = p*100;
    progressBar.style.width = perc + "%";
    progressThumb.style.left = perc + "%";
  }
  progressContainer.addEventListener("pointerdown", (e)=>{
    if(!audio.duration) return;
    const r = progressContainer.getBoundingClientRect();
    const pct = clamp01((e.clientX - r.left)/r.width);
    audio.currentTime = pct * audio.duration;
  }, { passive:true });

  audio.addEventListener("timeupdate", ()=>{
    if(!audio.duration) return;
    currentTimeEl.textContent = fmt(audio.currentTime);
    totalTimeEl.textContent = fmt(audio.duration);
    setProgress(audio.currentTime / audio.duration);
    updateNow();
  });
  audio.addEventListener("loadedmetadata", ()=>{
    if(audio.duration) totalTimeEl.textContent = fmt(audio.duration);
    updateNow();
  });
  audio.addEventListener("play", ()=>{ setPlayIcons(); });
  audio.addEventListener("pause", ()=>{ setPlayIcons(); });

  // volume
  volumeSlider.addEventListener("input", ()=>{
    audio.volume = Number(volumeSlider.value)/100;
  });

  // close psy
  psyClose.addEventListener("click", ()=>{
    psyEl.classList.remove("open");
    psyEl.style.display = "none";
  });

  // ====== PSY CANVAS (ANIMA SIEMPRE) ======
  const ctx = psyCanvas.getContext("2d");

  // offscreen lava
  const lava = document.createElement("canvas");
  const lx = lava.getContext("2d");
  const balls = Array.from({length: 14}, ()=>({
    x: Math.random(), y: Math.random(),
    vx:(Math.random()*2-1)*0.09,
    vy:(Math.random()*2-1)*0.07,
    r: 0.10 + Math.random()*0.20,
    ph: Math.random()*Math.PI*2
  }));

  function resize(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    psyCanvas.width = Math.floor(innerWidth * dpr);
    psyCanvas.height = Math.floor(innerHeight * dpr);

    lava.width = Math.max(260, Math.floor(innerWidth * 0.60));
    lava.height = Math.max(260, Math.floor(innerHeight * 0.60));
  }
  addEventListener("resize", resize, { passive:true });
  resize();

  function drawLava(t){
    const W = lava.width, H = lava.height;
    const hueA = (t*18) % 360;
    const hueB = (hueA + 160) % 360;

    const g = lx.createLinearGradient(0,0,W,H);
    g.addColorStop(0, `hsl(${hueA} 95% 22%)`);
    g.addColorStop(1, `hsl(${hueB} 95% 14%)`);
    lx.globalCompositeOperation="source-over";
    lx.fillStyle=g;
    lx.fillRect(0,0,W,H);

    lx.globalCompositeOperation="screen";
    for(const b of balls){
      b.ph += 0.02;
      b.x += b.vx * 0.016;
      b.y += b.vy * 0.016;
      if(b.x < -0.2) b.x = 1.2; if(b.x > 1.2) b.x = -0.2;
      if(b.y < -0.2) b.y = 1.2; if(b.y > 1.2) b.y = -0.2;

      const cx = (b.x + 0.03*Math.sin(b.ph)) * W;
      const cy = (b.y + 0.03*Math.cos(b.ph*1.3)) * H;
      const rr = b.r * Math.min(W,H);

      const hh = (hueA + 80*Math.sin(b.ph*0.9)) % 360;
      const rg = lx.createRadialGradient(cx,cy, rr*0.08, cx,cy, rr);
      rg.addColorStop(0, `hsla(${hh} 100% 62% .70)`);
      rg.addColorStop(0.6, `hsla(${(hh+50)%360} 100% 50% .18)`);
      rg.addColorStop(1, `hsla(${(hh+120)%360} 100% 40% 0)`);
      lx.fillStyle=rg;
      lx.beginPath();
      lx.arc(cx,cy, rr, 0, Math.PI*2);
      lx.fill();
    }

    // scanlines setenteras
    lx.globalCompositeOperation="multiply";
    lx.fillStyle="rgba(0,0,0,.10)";
    for(let y=0;y<H;y+=3) lx.fillRect(0, y + Math.sin(t*1.7 + y*0.02)*1.2, W, 1);

    lx.globalCompositeOperation="source-over";
  }

  function loop(ms){
    requestAnimationFrame(loop);
    const t = ms*0.001;

    if(!psyCanvas.width || !psyCanvas.height) return;

    drawLava(t);

    const w = psyCanvas.width, h = psyCanvas.height;
    ctx.globalCompositeOperation="source-over";
    ctx.fillStyle="rgba(0,0,0,1)";
    ctx.fillRect(0,0,w,h);

    // kaleidoscopio
    const seg = 14;
    const ang = (Math.PI*2)/seg;
    const spin = t*0.35;
    const zoom = 1.15 + 0.12*Math.sin(t*1.1);

    ctx.save();
    ctx.translate(w/2,h/2);
    ctx.rotate(spin);

    const drawW = lava.width*zoom;
    const drawH = lava.height*zoom;

    for(let i=0;i<seg;i++){
      ctx.save();
      ctx.rotate(i*ang);
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.lineTo(Math.cos(-ang/2)*Math.max(w,h), Math.sin(-ang/2)*Math.max(w,h));
      ctx.lineTo(Math.cos( ang/2)*Math.max(w,h), Math.sin( ang/2)*Math.max(w,h));
      ctx.closePath();
      ctx.clip();

      if(i%2) ctx.scale(-1,1);

      const jx = Math.sin(t*1.7 + i)* (w*0.015);
      const jy = Math.cos(t*1.3 + i)* (h*0.015);

      ctx.globalCompositeOperation="screen";
      ctx.drawImage(lava, -drawW/2 + jx, -drawH/2 + jy, drawW, drawH);

      ctx.globalCompositeOperation="lighter";
      ctx.globalAlpha=0.18;
      ctx.drawImage(lava, -drawW/2 - jx*0.7, -drawH/2 - jy*0.7, drawW*1.02, drawH*1.02);
      ctx.globalAlpha=1;

      ctx.restore();
    }
    ctx.restore();

    // viñeta
    ctx.globalCompositeOperation="multiply";
    const vg = ctx.createRadialGradient(w/2,h/2, Math.min(w,h)*0.15, w/2,h/2, Math.min(w,h)*0.78);
    vg.addColorStop(0,"rgba(0,0,0,0)");
    vg.addColorStop(1,"rgba(0,0,0,.62)");
    ctx.fillStyle=vg;
    ctx.fillRect(0,0,w,h);
    ctx.globalCompositeOperation="source-over";
  }

  requestAnimationFrame(loop);

  // init
  loadTrack(0);
  updateNow();
  setPlayIcons();
</script>

</body>
</html>
